# streamlit_app.py
# Complete working AI Astrology App with Enhanced Fortune Telling

import streamlit as st
import datetime
import os
import openai

# Page config
st.set_page_config(
    page_title="AI à¹‚à¸«à¸£à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œà¹„à¸—à¸¢-à¸ˆà¸µà¸™",
    page_icon="ğŸ”®",
    layout="wide"
)

# Functions
def get_thai_fortune_details(birth_date):
    days = ['à¸ˆà¸±à¸™à¸—à¸£à¹Œ', 'à¸­à¸±à¸‡à¸„à¸²à¸£', 'à¸à¸¸à¸˜', 'à¸à¸¤à¸«à¸±à¸ªà¸šà¸”à¸µ', 'à¸¨à¸¸à¸à¸£à¹Œ', 'à¹€à¸ªà¸²à¸£à¹Œ', 'à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ']
    colors = ['à¹€à¸«à¸¥à¸·à¸­à¸‡', 'à¸Šà¸¡à¸à¸¹', 'à¹€à¸‚à¸µà¸¢à¸§', 'à¸ªà¹‰à¸¡', 'à¸™à¹‰à¸³à¹€à¸‡à¸´à¸™', 'à¸¡à¹ˆà¸§à¸‡', 'à¹à¸”à¸‡']
    day_of_week = birth_date.weekday()
    return days[day_of_week], colors[day_of_week]

def get_chinese_fortune_details(birth_year):
    animals = [
        ('à¸«à¸™à¸¹', 'Rat'), ('à¸§à¸±à¸§', 'Ox'), ('à¹€à¸ªà¸·à¸­', 'Tiger'), ('à¸à¸£à¸°à¸•à¹ˆà¸²à¸¢', 'Rabbit'),
        ('à¸¡à¸±à¸‡à¸à¸£', 'Dragon'), ('à¸‡à¸¹', 'Snake'), ('à¸¡à¹‰à¸²', 'Horse'), ('à¹à¸à¸°', 'Goat'),
        ('à¸¥à¸´à¸‡', 'Monkey'), ('à¹„à¸à¹ˆ', 'Rooster'), ('à¸«à¸¡à¸²', 'Dog'), ('à¸«à¸¡à¸¹', 'Pig')
    ]
    index = (birth_year - 1900) % 12
    return animals[index]

def get_bazi_elements(birth_date, birth_time):
    heavenly_stems = ["ç”²", "ä¹™", "ä¸™", "ä¸", "æˆŠ", "å·±", "åºš", "è¾›", "å£¬", "ç™¸"]
    earthly_branches = ["å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"]
    
    elements = {
        "æœ¨": {"chinese": "æœ¨", "thai": "à¹„à¸¡à¹‰", "emoji": "ğŸŒ³", "color": "#22c55e"},
        "ç«": {"chinese": "ç«", "thai": "à¹„à¸Ÿ", "emoji": "ğŸ”¥", "color": "#ef4444"},
        "åœŸ": {"chinese": "åœŸ", "thai": "à¸”à¸´à¸™", "emoji": "ğŸ”ï¸", "color": "#a3a3a3"},
        "é‡‘": {"chinese": "é‡‘", "thai": "à¹‚à¸¥à¸«à¸°", "emoji": "âš¡", "color": "#fbbf24"},
        "æ°´": {"chinese": "æ°´", "thai": "à¸™à¹‰à¸³", "emoji": "ğŸ’§", "color": "#3b82f6"}
    }
    
    year = birth_date.year
    month = birth_date.month
    day = birth_date.day
    hour = birth_time.hour
    
    year_stem = heavenly_stems[(year - 4) % 10]
    year_branch = earthly_branches[(year - 4) % 12]
    month_stem = heavenly_stems[(month - 1) % 10]
    month_branch = earthly_branches[(month - 1) % 12]
    day_stem = heavenly_stems[(day - 1) % 10]
    day_branch = earthly_branches[(day - 1) % 12]
    hour_stem = heavenly_stems[(hour // 2) % 10]
    hour_branch = earthly_branches[(hour // 2) % 12]
    
    dominant_element_key = list(elements.keys())[year % 5]
    dominant_element = elements[dominant_element_key]
    
    return {
        "year_pillar": f"{year_stem}{year_branch}",
        "month_pillar": f"{month_stem}{month_branch}",
        "day_pillar": f"{day_stem}{day_branch}",
        "hour_pillar": f"{hour_stem}{hour_branch}",
        "dominant_element": dominant_element
    }

def generate_enhanced_ai_fortune(birth_date, birth_time, day_name, thai_color, thai_animal):
    api_key = os.environ.get("OPENAI_API_KEY")
    
    if not api_key:
        return "âŒ à¹„à¸¡à¹ˆà¸à¸š OpenAI API Key à¹ƒà¸™à¸£à¸°à¸šà¸š à¸à¸£à¸¸à¸“à¸²à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² Environment Variable"
    
    try:
        openai.api_key = api_key
        
        today = datetime.date.today()
        age = today.year - birth_date.year - ((today.month, today.day) < (birth_date.month, birth_date.day))
        
        # Enhanced detailed prompt
        text_prompt = (
            f"à¸ˆà¸‡à¸ªà¸§à¸¡à¸šà¸—à¸šà¸²à¸—à¹€à¸›à¹‡à¸™ 'à¸‹à¸´à¸™à¹à¸ªà¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸¨à¸²à¸ªà¸•à¸£à¹Œà¸ˆà¸µà¸™à¸£à¸°à¸”à¸±à¸šà¸›à¸£à¸¡à¸²à¸ˆà¸²à¸£à¸¢à¹Œ' à¸—à¸³à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸”à¸§à¸‡à¸Šà¸°à¸•à¸² (à¸›à¸²à¸ˆà¸·à¹ˆà¸­ - å…«å­—) à¸‚à¸­à¸‡à¸šà¸¸à¸„à¸„à¸¥à¸œà¸¹à¹‰à¸–à¸·à¸­à¸à¸³à¹€à¸™à¸´à¸”à¹ƒà¸™à¸§à¸±à¸™ {day_name}, à¹€à¸§à¸¥à¸² {birth_time.strftime('%H:%M')}, à¹ƒà¸™à¸›à¸µà¸™à¸±à¸à¸©à¸±à¸•à¸£ {thai_animal} (à¸‹à¸¶à¹ˆà¸‡à¸¡à¸µà¸£à¸²à¸à¸à¸²à¸™à¸˜à¸²à¸•à¸¸à¸•à¸²à¸¡à¸›à¸µà¹€à¸à¸´à¸”) à¹‚à¸”à¸¢à¸¡à¸µà¸ªà¸µ {thai_color} à¹€à¸›à¹‡à¸™à¸ªà¸µà¹€à¸ªà¸£à¸´à¸¡à¸”à¸§à¸‡à¸Šà¸°à¸•à¸².\n\n"
            f"**à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¹ƒà¸™à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸”à¸§à¸‡à¸Šà¸°à¸•à¸²:**\n"
            f"à¸ˆà¸‡à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸”à¹‰à¸§à¸¢à¸à¸²à¸£ 'à¹€à¸›à¸´à¸”à¸Ÿà¹‰à¸²à¸­à¹ˆà¸²à¸™à¸Šà¸°à¸•à¸²' à¹‚à¸”à¸¢à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸›à¸±à¸ˆà¸ˆà¸±à¸¢à¸à¸·à¹‰à¸™à¸à¸²à¸™à¹à¸«à¹ˆà¸‡ 'à¸Ÿà¹‰à¸²-à¸”à¸´à¸™-à¸„à¸™' à¸‚à¸­à¸‡à¸”à¸§à¸‡à¸Šà¸°à¸•à¸²à¸™à¸µà¹‰à¸à¹ˆà¸­à¸™:\n"
            f" - **à¸Ÿà¹‰à¸² (å¤©):** à¸­à¸˜à¸´à¸šà¸²à¸¢à¸§à¹ˆà¸²à¸à¸¥à¸±à¸‡à¹à¸«à¹ˆà¸‡à¸›à¸µà¸™à¸±à¸à¸©à¸±à¸•à¸£ {thai_animal} à¸à¸³à¸«à¸™à¸” 'à¸˜à¸²à¸•à¸¸à¸›à¸£à¸°à¸ˆà¸³à¸•à¸±à¸§' à¹à¸¥à¸°à¸ à¸²à¸à¸£à¸§à¸¡à¹à¸«à¹ˆà¸‡à¸Šà¸µà¸§à¸´à¸•à¹„à¸§à¹‰à¸­à¸¢à¹ˆà¸²à¸‡à¹„à¸£\n"
            f" - **à¸”à¸´à¸™ (åœ°):** à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸§à¹ˆà¸²à¸à¸¥à¸±à¸‡à¸«à¸¢à¸´à¸™ (é™°) à¸«à¸£à¸·à¸­ à¸«à¸¢à¸²à¸‡ (é™½) à¸ˆà¸²à¸à¹€à¸§à¸¥à¸²à¸•à¸à¸Ÿà¸²à¸ {birth_time.strftime('%H:%M')} à¸ªà¹ˆà¸‡à¸œà¸¥à¸•à¹ˆà¸­à¹€à¸ªà¸–à¸µà¸¢à¸£à¸ à¸²à¸à¹à¸¥à¸°à¸ˆà¸±à¸‡à¸«à¸§à¸°à¸Šà¸µà¸§à¸´à¸•à¸­à¸¢à¹ˆà¸²à¸‡à¹„à¸£\n"
            f" - **à¸„à¸™ (äºº):** à¸­à¸˜à¸´à¸šà¸²à¸¢à¸§à¹ˆà¸²à¸­à¸´à¸—à¸˜à¸´à¸à¸¥à¸ˆà¸²à¸à¸§à¸±à¸™à¹€à¸à¸´à¸” ({day_name}) à¸•à¸²à¸¡à¸„à¸•à¸´à¹„à¸—à¸¢ à¸Šà¹ˆà¸§à¸¢à¹€à¸ªà¸£à¸´à¸¡à¸«à¸£à¸·à¸­à¸‚à¸±à¸”à¹€à¸à¸¥à¸²à¸à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸Ÿà¹‰à¸²à¹à¸¥à¸°à¸”à¸´à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¹„à¸£à¸šà¹‰à¸²à¸‡\n"
            f"à¸ˆà¸‡à¸­à¸˜à¸´à¸šà¸²à¸¢à¸›à¸à¸´à¸ªà¸±à¸¡à¸à¸±à¸™à¸˜à¹Œà¸‚à¸­à¸‡à¸—à¸±à¹‰à¸‡à¸ªà¸²à¸¡à¸ªà¹ˆà¸§à¸™à¸™à¸µà¹‰ à¹€à¸à¸·à¹ˆà¸­à¸ªà¸£à¸¸à¸›à¸£à¸²à¸à¸à¸²à¸™à¸„à¸§à¸²à¸¡à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸—à¸µà¹ˆà¸¥à¸¶à¸à¸‹à¸¶à¹‰à¸‡à¹à¸¥à¸°à¸™à¹ˆà¸²à¹€à¸Šà¸·à¹ˆà¸­à¸–à¸·à¸­à¸ªà¸¹à¸‡à¸ªà¸¸à¸”\n\n"
            f"à¹€à¸¡à¸·à¹ˆà¸­à¸§à¸²à¸‡à¸£à¸²à¸à¸à¸²à¸™à¹à¸«à¹ˆà¸‡à¸Šà¸°à¸•à¸²à¹à¸¥à¹‰à¸§ à¸ˆà¸¶à¸‡à¹€à¸£à¸´à¹ˆà¸¡ 'à¸Šà¸µà¹‰à¸Šà¸±à¸”à¸à¸¢à¸²à¸à¸£à¸“à¹Œ' à¸­à¸¢à¹ˆà¸²à¸‡à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¹ƒà¸™à¸«à¸±à¸§à¸‚à¹‰à¸­à¸•à¹ˆà¸­à¹„à¸›à¸™à¸µà¹‰:\n"
            f"1. **à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹à¸à¹ˆà¸™à¹à¸—à¹‰à¹à¸¥à¸°à¸à¸¥à¸±à¸‡à¸˜à¸²à¸•à¸¸:** à¹€à¸ˆà¸²à¸°à¸¥à¸¶à¸à¸–à¸¶à¸‡à¸šà¸¸à¸„à¸¥à¸´à¸à¸ à¸²à¸ à¸­à¸¸à¸›à¸™à¸´à¸ªà¸±à¸¢ à¸ˆà¸¸à¸”à¹à¸‚à¹‡à¸‡à¸—à¸µà¹ˆà¸„à¸§à¸£à¸ªà¹ˆà¸‡à¹€à¸ªà¸£à¸´à¸¡ à¹à¸¥à¸°à¸ˆà¸¸à¸”à¸­à¹ˆà¸­à¸™à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸£à¸°à¸§à¸±à¸‡ à¸•à¸²à¸¡à¸«à¸¥à¸±à¸à¹€à¸šà¸à¸ˆà¸˜à¸²à¸•à¸¸ (à¸”à¸´à¸™ à¸™à¹‰à¸³ à¹„à¸Ÿ à¹„à¸¡à¹‰ à¸—à¸­à¸‡)\n"
            f"2. **à¸£à¸°à¸”à¸±à¸šà¸§à¸²à¸ªà¸™à¸²à¹à¸¥à¸°à¸„à¸³à¹€à¸•à¸·à¸­à¸™à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸ˆà¸³à¹ƒà¸«à¹‰à¸‚à¸¶à¹‰à¸™à¹ƒà¸ˆ:** à¸ˆà¸²à¸à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” à¹ƒà¸«à¹‰à¸›à¸£à¸°à¹€à¸¡à¸´à¸™ 'à¸„à¸°à¹à¸™à¸™à¸§à¸²à¸ªà¸™à¸²' à¹€à¸•à¹‡à¸¡ 100 (à¹€à¸à¸“à¸‘à¹Œ: 90+ à¸„à¸·à¸­à¸”à¸§à¸‡à¸Šà¸°à¸•à¸²à¸£à¸°à¸”à¸±à¸šà¸ªà¸¹à¸‡, 60-89 à¸„à¸·à¸­à¸£à¸°à¸”à¸±à¸šà¸›à¸²à¸™à¸à¸¥à¸²à¸‡-à¸”à¸µ) à¸ˆà¸²à¸à¸™à¸±à¹‰à¸™à¹ƒà¸«à¹‰à¸­à¸˜à¸´à¸šà¸²à¸¢à¸–à¸¶à¸‡ 'à¸§à¸²à¸ªà¸™à¸²à¸—à¸µà¹ˆà¸”à¸µ' à¸«à¸£à¸·à¸­à¸à¸£à¸ªà¸§à¸£à¸£à¸„à¹Œà¸—à¸µà¹ˆà¹‚à¸”à¸”à¹€à¸”à¹ˆà¸™à¸‚à¸­à¸‡à¸”à¸§à¸‡à¸Šà¸°à¸•à¸²à¸™à¸µà¹‰ à¹à¸¥à¹‰à¸§à¸ˆà¸¶à¸‡à¹ƒà¸«à¹‰ **'à¸„à¸³à¹€à¸•à¸·à¸­à¸™' à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸²à¸à¸£à¸°à¸Šà¸±à¸š à¸£à¸¸à¸™à¹à¸£à¸‡ à¹à¸•à¹ˆà¹à¸à¸‡à¸”à¹‰à¸§à¸¢à¸„à¸§à¸²à¸¡à¸›à¸£à¸²à¸£à¸–à¸™à¸²à¸”à¸µ (à¸‚à¸­à¸„à¸§à¸²à¸¡à¸¢à¸²à¸§à¹€à¸›à¹‡à¸™à¸à¸´à¹€à¸¨à¸©à¹ƒà¸™à¸ªà¹ˆà¸§à¸™à¸™à¸µà¹‰à¹€à¸à¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸Šà¸±à¸”à¹€à¸ˆà¸™) à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸œà¸¹à¹‰à¸£à¸±à¸šà¸ªà¸²à¸£à¸ˆà¸³à¸‚à¸¶à¹‰à¸™à¹ƒà¸ˆà¹à¸¥à¸°à¸•à¸£à¸°à¸«à¸™à¸±à¸à¸–à¸¶à¸‡à¸œà¸¥à¸—à¸µà¹ˆà¸ˆà¸°à¸•à¸²à¸¡à¸¡à¸²**\n"
            f"3. **à¸à¸¢à¸²à¸à¸£à¸“à¹Œà¸Šà¸°à¸•à¸² 6 à¹€à¸”à¸·à¸­à¸™à¸‚à¹‰à¸²à¸‡à¸«à¸™à¹‰à¸²:** à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹à¸™à¸§à¹‚à¸™à¹‰à¸¡à¸ªà¸³à¸„à¸±à¸à¹ƒà¸™à¸”à¹‰à¸²à¸™ à¸à¸²à¸£à¸‡à¸²à¸™, à¸à¸²à¸£à¹€à¸‡à¸´à¸™, à¹à¸¥à¸°à¸„à¸§à¸²à¸¡à¸£à¸±à¸ à¸—à¸µà¹ˆà¸ˆà¸°à¹€à¸à¸´à¸”à¸‚à¸¶à¹‰à¸™à¹ƒà¸™à¸­à¸µà¸ 6 à¹€à¸”à¸·à¸­à¸™à¸™à¸±à¸šà¸ˆà¸²à¸à¸™à¸µà¹‰ à¸Šà¸µà¹‰à¸Šà¸±à¸”à¸–à¸¶à¸‡à¹€à¸”à¸·à¸­à¸™à¸—à¸µà¹ˆà¹‚à¸”à¸”à¹€à¸”à¹ˆà¸™à¹à¸¥à¸°à¹€à¸”à¸·à¸­à¸™à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸£à¸°à¸¡à¸±à¸”à¸£à¸°à¸§à¸±à¸‡\n"
            f"4. **à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¹à¸«à¹ˆà¸‡à¸„à¸§à¸²à¸¡à¸¡à¸±à¹ˆà¸‡à¸„à¸±à¹ˆà¸‡ (à¸à¸²à¸£à¸‡à¸²à¸™-à¸à¸²à¸£à¹€à¸‡à¸´à¸™):** à¸Šà¸µà¹‰à¹à¸™à¸°à¸­à¸²à¸Šà¸µà¸à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¹€à¸ªà¸£à¸´à¸¡à¸˜à¸²à¸•à¸¸à¸›à¸£à¸°à¸ˆà¸³à¸•à¸±à¸§ à¸—à¸´à¸¨à¸—à¸²à¸‡à¸à¸²à¸£à¸¥à¸‡à¸—à¸¸à¸™à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡ **à¹€à¸à¸´à¹ˆà¸¡à¸«à¸±à¸§à¸‚à¹‰à¸­ 'à¸¡à¸¸à¸¡à¸¡à¸­à¸‡à¸ˆà¸²à¸à¹€à¸ˆà¹‰à¸²à¸„à¸™à¸™à¸²à¸¢à¸„à¸™ (à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸«à¸±à¸§à¸«à¸™à¹‰à¸²à¸‡à¸²à¸™à¸„à¸´à¸”à¸à¸±à¸šà¸—à¹ˆà¸²à¸™à¹ƒà¸™à¸•à¸­à¸™à¸™à¸µà¹‰)' à¹‚à¸”à¸¢à¹ƒà¸«à¹‰à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹à¸šà¸šà¸•à¸£à¸‡à¹„à¸›à¸•à¸£à¸‡à¸¡à¸² à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸­à¹‰à¸­à¸¡à¸„à¹‰à¸­à¸¡ à¹à¸•à¹ˆà¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™à¹„à¸›à¹ƒà¸™à¹€à¸Šà¸´à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸£à¸£à¸„à¹Œà¹€à¸à¸·à¹ˆà¸­à¸à¸²à¸£à¸à¸±à¸’à¸™à¸² à¹„à¸¡à¹ˆà¸šà¸±à¹ˆà¸™à¸—à¸­à¸™à¸à¸³à¸¥à¸±à¸‡à¹ƒà¸ˆ** à¹à¸¥à¸°à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢à¸¡à¸­à¸š 'à¸„à¸³à¸„à¸¡à¸™à¸³à¸—à¸²à¸‡' à¸—à¸µà¹ˆà¸ªà¸£à¹‰à¸²à¸‡à¹à¸£à¸‡à¸šà¸±à¸™à¸”à¸²à¸¥à¹ƒà¸ˆà¹ƒà¸™à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™ 1 à¸›à¸£à¸°à¹‚à¸¢à¸„\n"
            f"5. **à¸§à¸²à¸ªà¸™à¸²à¹à¸«à¹ˆà¸‡à¸£à¸±à¸à¹à¸¥à¸°à¹€à¸„à¸£à¸·à¸­à¸‚à¹ˆà¸²à¸¢à¸ªà¸±à¸¡à¸à¸±à¸™à¸˜à¹Œ (à¸„à¸§à¸²à¸¡à¸£à¸±à¸-à¸ªà¸±à¸‡à¸„à¸¡):** à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸¥à¸±à¸à¸©à¸“à¸°à¹€à¸™à¸·à¹‰à¸­à¸„à¸¹à¹ˆà¸•à¸²à¸¡à¸˜à¸²à¸•à¸¸à¸—à¸µà¹ˆà¸ªà¸¡à¸à¸‡à¸©à¹Œ à¸§à¸´à¸˜à¸µà¸à¸²à¸£à¹€à¸ªà¸£à¸´à¸¡à¸ªà¸£à¹‰à¸²à¸‡à¹€à¸ªà¸™à¹ˆà¸«à¹Œ à¹à¸¥à¸°à¸à¸²à¸£à¸šà¸£à¸´à¸«à¸²à¸£à¸„à¸§à¸²à¸¡à¸ªà¸±à¸¡à¸à¸±à¸™à¸˜à¹Œà¸à¸±à¸šà¸„à¸™à¸£à¸­à¸šà¸‚à¹‰à¸²à¸‡\n"
            f"6. **à¸ªà¸¡à¸”à¸¸à¸¥à¹à¸«à¹ˆà¸‡à¸ªà¸±à¸‡à¸‚à¸²à¸£ (à¸ªà¸¸à¸‚à¸ à¸²à¸):** à¹ƒà¸«à¹‰à¸„à¸³à¹à¸™à¸°à¸™à¸³à¹ƒà¸™à¸à¸²à¸£à¸”à¸¹à¹à¸¥à¸ªà¸¸à¸‚à¸ à¸²à¸à¸•à¸²à¸¡à¸˜à¸²à¸•à¸¸à¹€à¸ˆà¹‰à¸²à¹€à¸£à¸·à¸­à¸™ à¹à¸¥à¸°à¸­à¸§à¸±à¸¢à¸§à¸°à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¹ƒà¸ªà¹ˆà¹ƒà¸ˆà¹€à¸›à¹‡à¸™à¸à¸´à¹€à¸¨à¸©\n"
            f"7. **à¸à¸¥à¸¢à¸¸à¸—à¸˜à¹Œà¸›à¸£à¸±à¸šà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸Šà¸°à¸•à¸²:** à¹à¸™à¸°à¸™à¸³à¹à¸™à¸§à¸—à¸²à¸‡à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸Šà¸µà¸§à¸´à¸• à¸à¸²à¸£à¸›à¸£à¸±à¸šà¸ªà¸ à¸²à¸à¹à¸§à¸”à¸¥à¹‰à¸­à¸¡ (à¸®à¸§à¸‡à¸ˆà¸¸à¹‰à¸¢) à¸«à¸£à¸·à¸­à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸§à¸±à¸•à¸–à¸¸à¸¡à¸‡à¸„à¸¥/à¸ªà¸µà¸¡à¸‡à¸„à¸¥ à¹€à¸à¸·à¹ˆà¸­à¸›à¸£à¸±à¸šà¸ªà¸¡à¸”à¸¸à¸¥à¸˜à¸²à¸•à¸¸à¹à¸¥à¸°à¹€à¸ªà¸£à¸´à¸¡à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸´à¸£à¸´à¸¡à¸‡à¸„à¸¥\n\n"
            f"**à¸ªà¹ˆà¸§à¸™à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢: à¸šà¸—à¸ªà¸£à¸¸à¸›à¸ªà¸³à¸«à¸£à¸±à¸šà¸—à¹ˆà¸²à¸™ (à¸‰à¸šà¸±à¸šà¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸‡à¹ˆà¸²à¸¢)**\n"
            f"à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸„à¸³à¸à¸¢à¸²à¸à¸£à¸“à¹Œà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” à¸ˆà¸‡à¸ªà¸£à¸¸à¸›à¹ƒà¸ˆà¸„à¸§à¸²à¸¡à¸ªà¸³à¸„à¸±à¸à¹ƒà¸™à¹à¸•à¹ˆà¸¥à¸°à¸”à¹‰à¸²à¸™ (à¸ à¸²à¸à¸£à¸§à¸¡, à¸à¸²à¸£à¸‡à¸²à¸™, à¸„à¸§à¸²à¸¡à¸£à¸±à¸, à¹à¸¥à¸°à¸„à¸³à¹€à¸•à¸·à¸­à¸™à¸—à¸µà¹ˆà¸ªà¸³à¸„à¸±à¸à¸—à¸µà¹ˆà¸ªà¸¸à¸”) à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¸—à¸µà¹ˆà¸„à¸™à¸—à¸±à¹ˆà¸§à¹„à¸›à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸‡à¹ˆà¸²à¸¢à¹à¸¥à¸°à¸™à¸³à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¸—à¸±à¸™à¸—à¸µ à¹‚à¸”à¸¢à¹à¸¢à¸à¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¹†\n\n"
            f"à¸ˆà¸‡à¸£à¸ˆà¸™à¸²à¸„à¸³à¸à¸¢à¸²à¸à¸£à¸“à¹Œà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹€à¸›à¹‡à¸™ **'à¸ à¸²à¸©à¸²à¹„à¸—à¸¢'** à¸”à¹‰à¸§à¸¢à¸¥à¸µà¸¥à¸²à¸‚à¸­à¸‡à¸‹à¸´à¸™à¹à¸ªà¸œà¸¹à¹‰à¸—à¸£à¸‡à¸ à¸¹à¸¡à¸´ à¸¡à¸µà¸„à¸§à¸²à¸¡à¸«à¸™à¸±à¸à¹à¸™à¹ˆà¸™ à¸Šà¸±à¸”à¹€à¸ˆà¸™ à¹à¸¥à¸°à¹ƒà¸«à¹‰à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸—à¸µà¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸™à¸³à¹„à¸›à¸›à¸£à¸±à¸šà¹ƒà¸Šà¹‰à¹ƒà¸™à¸Šà¸µà¸§à¸´à¸•à¹„à¸”à¹‰à¸ˆà¸£à¸´à¸‡"
        )
        
        response = openai.ChatCompletion.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "system", 
                    "content": "à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸‹à¸´à¸™à¹à¸ªà¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸¨à¸²à¸ªà¸•à¸£à¹Œà¸ˆà¸µà¸™à¸£à¸°à¸”à¸±à¸šà¸›à¸£à¸¡à¸²à¸ˆà¸²à¸£à¸¢à¹Œ à¸¡à¸µà¸›à¸£à¸°à¸ªà¸šà¸à¸²à¸£à¸“à¹Œà¸à¸§à¹ˆà¸² 50 à¸›à¸µ à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸—à¸±à¹‰à¸‡à¹‚à¸«à¸£à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œà¹„à¸—à¸¢à¹à¸¥à¸°à¸ˆà¸µà¸™ à¸›à¸²à¸ˆà¸·à¹ˆà¸­ à¸®à¸§à¸‡à¸ˆà¸¸à¹‰à¸¢ à¹à¸¥à¸°à¹€à¸šà¸à¸ˆà¸˜à¸²à¸•à¸¸ à¹ƒà¸«à¹‰à¸„à¸³à¸—à¸³à¸™à¸²à¸¢à¸—à¸µà¹ˆà¸¥à¸¶à¸à¸‹à¸¶à¹‰à¸‡ à¹à¸¡à¹ˆà¸™à¸¢à¸³ à¹à¸¥à¸°à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸£à¸£à¸„à¹Œ"
                },
                {"role": "user", "content": text_prompt}
            ],
            max_tokens=2000,
            temperature=0.8
        )
        
        return response.choices[0].message.content
        
    except Exception as e:
        return f"âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ AI: {str(e)}"

# CSS
st.markdown("""
<style>
body {
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
}
.main {
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
}
.stApp {
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
}

.board {
    background: linear-gradient(145deg, #fef3c7, #fbbf24);
    border: none;
    border-radius: 20px;
    padding: 20px 15px;
    text-align: center;
    box-shadow: 0 15px 35px rgba(220, 38, 38, 0.2);
    margin: 15px 0;
    border-top: 4px solid #dc2626;
}

.board h3 {
    color: #991b1b;
    margin-bottom: 20px;
    font-size: 1.5em;
    font-weight: 600;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.info-item {
    background: rgba(255, 255, 255, 0.9);
    padding: 15px 10px;
    border-radius: 12px;
    border: 1px solid rgba(220, 38, 38, 0.3);
}

.info-item .label {
    font-size: 0.9em;
    color: #991b1b;
    font-weight: 600;
    margin-bottom: 5px;
}

.info-item .value {
    font-size: 1.2em;
    font-weight: 700;
    color: #7f1d1d;
    margin: 0;
}

.animal-display {
    background: linear-gradient(45deg, #fbbf24, #f59e0b);
    border-radius: 50%;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 15px auto;
    border: 3px solid #dc2626;
}

.animal-emoji {
    font-size: 2.5em;
}

.color-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin: 8px auto;
    border: 3px solid #dc2626;
}

.fortune-content {
    background: rgba(255,255,255,0.95);
    padding: 30px;
    border-radius: 15px;
    margin: 20px 0;
    line-height: 1.8;
    color: #333;
    border-left: 5px solid #dc2626;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    font-size: 1.1em;
}

.fortune-section {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e5e5e5;
}

.fortune-section:last-child {
    border-bottom: none;
}

.section-title {
    color: #dc2626;
    font-weight: 700;
    font-size: 1.3em;
    margin-bottom: 15px;
    text-decoration: underline;
}
</style>
""", unsafe_allow_html=True)

# Header
st.markdown("""
<div style="
    text-align: center;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(20px);
    border-radius: 25px;
    padding: 25px 15px;
    margin-bottom: 20px;
    border: 1px solid rgba(255, 255, 255, 0.2);
">
    <h1 style="color: white; font-size: 3em; margin-bottom: 10px;">ğŸ”® AI à¹‚à¸«à¸£à¸²à¸ˆà¸²à¸£à¸¢à¹Œ ğŸ”®</h1>
    <p style="color: rgba(255, 255, 255, 0.9); font-size: 1.2em;">
        âœ¨ à¹„à¸‚à¸„à¸§à¸²à¸¡à¸¥à¸±à¸šà¹à¸«à¹ˆà¸‡à¸”à¸§à¸‡à¸”à¸²à¸§ à¸œà¸¹à¸à¸”à¸§à¸‡à¸Šà¸°à¸•à¸²à¹„à¸—à¸¢-à¸ˆà¸µà¸™à¹‚à¸šà¸£à¸²à¸“ âœ¨
    </p>
    <p style="color: rgba(255, 255, 255, 0.8); font-size: 1em;">
        ğŸ“œ à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸¥à¸¶à¸ à¸”à¹‰à¸§à¸¢à¸›à¸£à¸¡à¸²à¸ˆà¸²à¸£à¸¢à¹Œà¸‹à¸´à¸™à¹à¸ªà¹à¸«à¹ˆà¸‡à¸¨à¸²à¸ªà¸•à¸£à¹Œà¸ˆà¸µà¸™ ğŸ“œ
    </p>
</div>
""", unsafe_allow_html=True)

# Input section
st.markdown("### ğŸ“‹ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸«à¸£à¸±à¸šà¸œà¸¹à¸à¸”à¸§à¸‡")

col1, col2 = st.columns(2)

with col1:
    birth_date = st.date_input(
        "ğŸ“… à¸§à¸±à¸™/à¹€à¸”à¸·à¸­à¸™/à¸›à¸µà¹€à¸à¸´à¸”:", 
        datetime.date(1990, 1, 1),
        min_value=datetime.date(1950, 1, 1), 
        max_value=datetime.date.today()
    )

with col2:
    birth_time = st.time_input(
        "ğŸ• à¹€à¸§à¸¥à¸²à¹€à¸à¸´à¸”:", 
        datetime.time(12, 0)
    )

# Button
if st.button("ğŸ”® à¹€à¸›à¸´à¸”à¸”à¸§à¸‡à¸Šà¸°à¸•à¸²", use_container_width=True, type="primary"):
    st.balloons()
    
    day_name, thai_color = get_thai_fortune_details(birth_date)
    thai_animal, english_animal = get_chinese_fortune_details(birth_date.year)
    bazi = get_bazi_elements(birth_date, birth_time)
    
    col_left, col_right = st.columns(2)
    
    with col_left:
        zodiac_emojis = {
            "Rat": "ğŸ­", "Ox": "ğŸ®", "Tiger": "ğŸ¯", "Rabbit": "ğŸ°", "Dragon": "ğŸ²", 
            "Snake": "ğŸ", "Horse": "ğŸ´", "Goat": "ğŸ", "Monkey": "ğŸµ", 
            "Rooster": "ğŸ”", "Dog": "ğŸ¶", "Pig": "ğŸ·"
        }
        animal_emoji = zodiac_emojis.get(english_animal, "âœ¨")
        
        color_map = {
            'à¹à¸”à¸‡': '#dc2626', 'à¹€à¸‚à¸µà¸¢à¸§': '#16a34a', 'à¸™à¹‰à¸³à¹€à¸‡à¸´à¸™': '#2563eb',
            'à¹€à¸«à¸¥à¸·à¸­à¸‡': '#eab308', 'à¸¡à¹ˆà¸§à¸‡': '#9333ea', 'à¸Šà¸¡à¸à¸¹': '#ec4899',
            'à¸ªà¹‰à¸¡': '#ea580c', 'à¸‚à¸²à¸§': '#f8fafc', 'à¸”à¸³': '#1f2937'
        }
        display_color = color_map.get(thai_color, thai_color.lower())
        
        st.markdown(f"""
        <div class="board">
            <h3>ğŸ”® à¸à¸£à¸°à¸”à¸²à¸™à¸Šà¸±à¸™à¸©à¸²à¸ˆà¸£</h3>
            <div class="info-grid">
                <div class="info-item">
                    <div class="label">ğŸŒŸ à¸”à¸²à¸§à¸›à¸£à¸°à¸ˆà¸³à¸§à¸±à¸™</div>
                    <div class="value">à¸§à¸±à¸™{day_name}</div>
                </div>
                <div class="info-item">
                    <div class="label">ğŸ‰ à¸›à¸µà¸™à¸±à¸à¸©à¸±à¸•à¸£</div>
                    <div class="value">{thai_animal}</div>
                </div>
                <div class="info-item">
                    <div class="label">â° à¹€à¸§à¸¥à¸²à¹€à¸à¸´à¸”</div>
                    <div class="value">{birth_time.strftime('%H:%M')} à¸™.</div>
                </div>
                <div class="info-item">
                    <div class="label">ğŸ¨ à¸ªà¸µà¸¡à¸‡à¸„à¸¥</div>
                    <div class="color-circle" style="background-color: {display_color};"></div>
                    <div class="value">{thai_color}</div>
                </div>
            </div>
            <div class="animal-display">
                <span class="animal-emoji">{animal_emoji}</span>
            </div>
        </div>
        """, unsafe_allow_html=True)
    
    with col_right:
        st.markdown(f"""
        <div class="board">
            <h3>ğŸ® å…«å­—å‘½ç›¤</h3>
            <div class="info-grid">
                <div class="info-item">
                    <div class="label">å¹´æŸ± (à¸›à¸µ)</div>
                    <div class="value">{bazi['year_pillar']}</div>
                </div>
                <div class="info-item">
                    <div class="label">æœˆæŸ± (à¹€à¸”à¸·à¸­à¸™)</div>
                    <div class="value">{bazi['month_pillar']}</div>
                </div>
                <div class="info-item">
                    <div class="label">æ—¥æŸ± (à¸§à¸±à¸™)</div>
                    <div class="value">{bazi['day_pillar']}</div>
                </div>
                <div class="info-item">
                    <div class="label">æ™‚æŸ± (à¹€à¸§à¸¥à¸²)</div>
                    <div class="value">{bazi['hour_pillar']}</div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <div style="font-size: 1em; color: #991b1b; font-weight: 600;">à¸˜à¸²à¸•à¸¸à¸«à¸¥à¸±à¸</div>
                <div style="
                    width: 60px; height: 60px; border-radius: 50%; 
                    background-color: {bazi['dominant_element']['color']};
                    margin: 10px auto; display: flex; align-items: center; justify-content: center;
                    border: 3px solid #dc2626;
                ">
                    <span style="font-size: 2em;">{bazi['dominant_element']['emoji']}</span>
                </div>
                <div style="font-weight: 700; color: #7f1d1d;">
                    {bazi['dominant_element']['chinese']} ({bazi['dominant_element']['thai']})
                </div>
            </div>
        </div>
        """, unsafe_allow_html=True)
    
    st.markdown("### ğŸ“œ à¸„à¸³à¸à¸¢à¸²à¸à¸£à¸“à¹Œà¸”à¸§à¸‡à¸Šà¸°à¸•à¸²à¸ˆà¸²à¸à¸‹à¸´à¸™à¹à¸ªà¸›à¸£à¸¡à¸²à¸ˆà¸²à¸£à¸¢à¹Œ")
    
    with st.spinner("ğŸ¤– à¸‹à¸´à¸™à¹à¸ªà¸›à¸£à¸¡à¸²à¸ˆà¸²à¸£à¸¢à¹Œà¸à¸³à¸¥à¸±à¸‡à¹€à¸›à¸´à¸”à¸Ÿà¹‰à¸²à¸­à¹ˆà¸²à¸™à¸Šà¸°à¸•à¸² à¸à¸£à¸¸à¸“à¸²à¸£à¸­à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆ..."):
        fortune_text = generate_enhanced_ai_fortune(birth_date, birth_time, day_name, thai_color, thai_animal)
    
    if fortune_text:
        st.markdown(f"""
        <div class="fortune-content">
            {fortune_text.replace('\\n', '<br>').replace('**', '<strong>').replace('**', '</strong>')}
        </div>
        """, unsafe_allow_html=True)

st.markdown("---")
st.markdown(
    '<p style="text-align: center; color: rgba(255,255,255,0.7);">'
    'à¸à¸±à¸’à¸™à¸²à¹‚à¸”à¸¢ AI à¹‚à¸«à¸£à¸²à¸ˆà¸²à¸£à¸¢à¹Œ | à¹ƒà¸Šà¹‰ OpenAI GPT-4o | Enhanced by à¸‹à¸´à¸™à¹à¸ªà¸›à¸£à¸¡à¸²à¸ˆà¸²à¸£à¸¢à¹Œ</p>', 
    unsafe_allow_html=True
)
